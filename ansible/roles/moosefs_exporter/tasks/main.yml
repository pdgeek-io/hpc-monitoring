---
- name: Check if running MooseFS deployment
  debug:
    msg: "Deploying MooseFS Exporter on {{ ansible_distribution }} {{ ansible_distribution_version }}"

- name: Ensure moosefs_exporter user exists
  user:
    name: "{{ moosefs_exporter_user }}"
    system: yes
    shell: /sbin/nologin
    comment: "MooseFS Prometheus Exporter"

- name: Install Python dependencies for MooseFS monitoring
  package:
    name:
      - python3
      - python3-pip
    state: present

- name: Install prometheus_client Python package
  pip:
    name: prometheus_client
    state: present

- name: Create MooseFS exporter directory
  file:
    path: "{{ moosefs_exporter_install_dir }}/moosefs_exporter"
    state: directory
    mode: '0755'
    owner: "{{ moosefs_exporter_user }}"
    group: "{{ moosefs_exporter_user }}"

- name: Deploy MooseFS exporter script
  template:
    src: "moosefs_exporter.py.j2"
    dest: "{{ moosefs_exporter_install_dir }}/moosefs_exporter/moosefs_exporter.py"
    mode: '0755'
    owner: "{{ moosefs_exporter_user }}"
    group: "{{ moosefs_exporter_user }}"
  notify: Restart moosefs_exporter

- name: Deploy systemd service for moosefs_exporter
  template:
    src: "moosefs_exporter.service.j2"
    dest: "/etc/systemd/system/moosefs_exporter.service"
    mode: '0644'
  notify: Restart moosefs_exporter

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable and start moosefs_exporter service
  systemd:
    name: moosefs_exporter
    enabled: yes
    state: started
